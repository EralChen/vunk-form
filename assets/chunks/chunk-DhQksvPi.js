import{s as d,bf as L,bg as G,bh as k,c as C,Q as E,e as j}from"./chunk-BCtBXoS3.js";import{t as O}from"./chunk-BXL5conV.js";import{l as T,a as R,n as v,u as J,i as N,c as Q,s as S,t as g,r as q,e as $}from"./chunk-_oCi09ez.js";import{populateGroupLayer as z}from"./chunk-Colc7S6W.js";import{t as A}from"./chunk-Ds7mdJnJ.js";import"./chunk-Zpopvlea.js";import"./chunk-UADQAoLm.js";import"./chunk-DxfIC8xT.js";import"./chunk-fEI7Cr-O.js";import"./chunk-Ch0SDxT-.js";import"./chunk-DBIPdCjN.js";async function ye(e,a){const r=e.instance.portalItem;if(r?.id)return await r.load(a),B(e),e.validateItem&&e.validateItem(r),H(e,a)}function B(e){const a=e.instance.portalItem;if(!a?.type||!e.supportedTypes.includes(a.type))throw new d("portal:invalid-layer-item-type","Invalid layer item type '${type}', expected '${expectedType}'",{type:a?.type,expectedType:e.supportedTypes.join(", ")})}async function H(e,a){const r=e.instance,t=r.portalItem;if(!t)return;const{url:o,title:s}=t,n=L(t,"portal-item");if(r.type==="group")return K(r,n,e);o&&r.type!=="media"&&r.read({url:o},n);const l=new $,i=await M(e,l,a);return i&&r.read(i,n),r.resourceReferences={portalItem:t,paths:n.readResourcePaths??[]},r.type!=="subtype-group"&&r.read({title:s},n),G(r,n)}async function K(e,a,r){const t=e.portalItem;if(!e.sourceIsPortalItem)return;const{title:o,type:s}=t;if(s==="Group Layer"){if(!k(t,"Map"))throw new d("portal:invalid-layer-item-typekeyword","'Group Layer' item without 'Map' type keyword is not supported");return U(e)}return e.read({title:o},a),V(e,r)}async function U(e){const a=e.portalItem,r=await a.fetchData("json");if(!r)return;const t=L(a,"web-map");e.read(r,t),await z(e,r,{context:t}),e.resourceReferences={portalItem:a,paths:t.readResourcePaths??[]}}async function V(e,a){let r;const{portalItem:t}=e;if(!t)return;const o=t.type,s=a.layerModuleTypeMap;switch(o){case"Feature Service":case"Feature Collection":r=s.FeatureLayer;break;case"Stream Service":r=s.StreamLayer;break;case"Scene Service":r=s.SceneLayer;break;default:throw new d("portal:unsupported-item-type-as-group",`The item type '${o}' is not supported as a 'IGroupLayer'`)}const n=new $;let[l,i]=await Promise.all([r(),M(a,n)]),u=()=>l;if(o==="Feature Service"){const P=T(i)?.customParameters;i=t.url?await R(i,t.url,n):{};const m=v(i),h=J(i),F=N(i),p=[];if(m.length||h?.length){m.length&&p.push("SubtypeGroupLayer"),h?.length&&p.push("OrientedImageryLayer"),F?.length&&p.push("CatalogLayer");const w=[];for(const c of p){const y=s[c];w.push(y())}const D=await Promise.all(w),b=new Map;p.forEach((c,y)=>{b.set(c,D[y])}),u=c=>c.layerType?b.get(c.layerType)??l:l}const x=await ee(t.url,{customParameters:P,loadContext:n});return await f(e,u,i,x)}return o==="Scene Service"&&t.url&&(i=await Q(t,i,n)),S(i)>0?await f(e,u,i):await W(e,u)}async function W(e,a){const{portalItem:r}=e;if(!r?.url)return;const t=await A(r.url);t&&f(e,a,{layers:t.layers?.map(g),tables:t.tables?.map(g)})}async function f(e,a,r,t){let o=r.layers||[];const s=r.tables||[];if(e.portalItem?.type==="Feature Collection"?(o.forEach((n,l)=>{n.id=l,n?.layerDefinition?.type==="Table"&&s.push(n)}),o=o.filter(n=>n?.layerDefinition?.type!=="Table")):(o.reverse(),s.reverse()),o.forEach(n=>{const l=t?.(n);if(l||!t){const i=I(e,a(n),r,n,l);e.add(i)}}),s.length){const n=await C.FeatureLayer();s.forEach(l=>{const i=t?.(l);if(i||!t){const u=I(e,n,r,l,i);e.tables.add(u)}})}}function I(e,a,r,t,o){const s=e.portalItem,n={portalItem:s.clone(),layerId:t.id};t.url!=null&&(n.url=t.url);const l=new a(n);if("sourceJSON"in l&&(l.sourceJSON=o),l.type!=="subtype-group"&&l.type!=="catalog"&&(l.sublayerTitleMode="service-name"),s.type==="Feature Collection"){const i={origin:"portal-item",portal:s.portal||E.getDefault()};l.read(t,i);const u=r.showLegend;u!=null&&l.read({showLegend:u},i)}return l}async function M(e,a,r){if(e.supportsData===!1)return;const t=e.instance,o=t.portalItem;if(!o)return;let s=null;try{s=await o.fetchData("json",r)}catch{}if(Z(t)){let n=null;const l=await X(o,s,a);if((s?.layers||s?.tables)&&l>0){if(t.layerId==null){const i=v(s);t.layerId=t.type==="subtype-group"?i?.[0]:q(s)}n=Y(s,t),n&&s.showLegend!=null&&(n.showLegend=s.showLegend)}return l>1&&"sublayerTitleMode"in t&&t.sublayerTitleMode!=="service-name"&&(t.sublayerTitleMode="item-title-and-service-name"),n}return s}async function X(e,a,r){if(a?.layers&&a?.tables)return S(a);const t=j(e.url);if(!t)return 1;const o=await r.fetchServiceMetadata(t.url.path,{customParameters:T(a)?.customParameters}).catch(()=>null);return(a?.layers?.length??o?.layers?.length??0)+(a?.tables?.length??o?.tables?.length??0)}function Y(e,a){const{layerId:r}=a,t=e.layers?.find(o=>o.id===r)||e.tables?.find(o=>o.id===r);return t&&_(t,a)?t:null}function Z(e){return e.type!=="stream"&&"layerId"in e}function _(e,a){return!(a.type==="feature"&&"layerType"in e&&e.layerType==="SubtypeGroupLayer"||a.type==="subtype-group"&&!("layerType"in e))}async function ee(e,a){const{layersJSON:r}=await O(e,a);if(!r)return null;const t=[...r.layers,...r.tables];return o=>t.find(s=>s.id===o.id)}export{ye as load};
