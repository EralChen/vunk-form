function M(){return this._array=null,Promise.resolve()}function R(){var e=this._array;return this._array=null,Promise.resolve(e?{done:!1,value:e}:{done:!0,value:void 0})}function y(e){return new x(e instanceof Uint8Array?e:new Uint8Array(e))}function x(e){this._array=e}x.prototype.read=R;x.prototype.cancel=M;function N(e){return fetch(e).then(function(t){return t.body&&t.body.getReader?t.body.getReader():t.arrayBuffer().then(y)})}function T(e){return new Promise(function(t,n){var r=new XMLHttpRequest;r.responseType="arraybuffer",r.onload=function(){t(y(r.response))},r.onerror=n,r.ontimeout=n,r.open("GET",e,!0),r.send()})}function _(e){return(typeof fetch=="function"?N:T)(e)}function A(e){return typeof e.read=="function"?e:e.getReader()}var P=new Uint8Array(0);function q(){return this._source.cancel()}function G(e,t){if(!e.length)return t;if(!t.length)return e;var n=new Uint8Array(e.length+t.length);return n.set(e),n.set(t,e.length),n}function k(){var e=this,t=e._array.subarray(e._index);return e._source.read().then(function(n){return e._array=P,e._index=0,n.done?t.length>0?{done:!1,value:t}:{done:!0,value:void 0}:{done:!1,value:G(t,n.value)}})}function O(e){if((e|=0)<0)throw new Error("invalid length");var t=this,n=this._array.length-this._index;if(this._index+e<=this._array.length)return Promise.resolve(this._array.subarray(this._index,this._index+=e));var r=new Uint8Array(e);return r.set(this._array.subarray(this._index)),function i(){return t._source.read().then(function(a){return a.done?(t._array=P,t._index=0,n>0?r.subarray(0,n):null):n+a.value.length>=e?(t._array=a.value,t._index=e-n,r.set(a.value.subarray(0,e-n),n),r):(r.set(a.value,n),n+=a.value.length,i())})}()}function I(e){return typeof e.slice=="function"?e:new p(typeof e.read=="function"?e:e.getReader())}function p(e){this._source=e,this._array=P,this._index=0}p.prototype.read=k;p.prototype.slice=O;p.prototype.cancel=q;function H(){return this._source.cancel()}function V(e){return/^[nf]$/i.test(e)?!1:/^[yt]$/i.test(e)?!0:null}function X(e){return new Date(+e.substring(0,4),e.substring(4,6)-1,+e.substring(6,8))}function d(e){return!(e=e.trim())||isNaN(e=+e)?null:e}function z(e){return e.trim()||null}var J={B:d,C:z,D:X,F:d,L:V,M:d,N:d};function K(){var e=this,t=1;return e._source.slice(e._recordLength).then(function(n){return n&&n[0]!==26?{done:!1,value:e._fields.reduce(function(r,i){return r[i.name]=J[i.type](e._decode(n.subarray(t,t+=i.length))),r},{})}:{done:!0,value:void 0}})}function h(e){return new DataView(e.buffer,e.byteOffset,e.byteLength)}function Q(e,t){return e=I(e),e.slice(32).then(function(n){var r=h(n);return e.slice(r.getUint16(8,!0)-32).then(function(i){return new C(e,t,r,h(i))})})}function C(e,t,n,r){this._source=e,this._decode=t.decode.bind(t),this._recordLength=n.getUint16(10,!0),this._fields=[];for(var i=0;r.getUint8(i)!==13;i+=32){for(var a=0;a<11&&r.getUint8(i+a)!==0;++a);this._fields.push({name:this._decode(new Uint8Array(r.buffer,r.byteOffset+i,a)),type:String.fromCharCode(r.getUint8(i+11)),length:r.getUint8(i+16)})}}var S=C.prototype;S.read=K;S.cancel=H;function W(){return this._source.cancel()}function g(e){var t=40,n,r=e.getInt32(36,!0),i=new Array(r);for(n=0;n<r;++n,t+=16)i[n]=[e.getFloat64(t,!0),e.getFloat64(t+8,!0)];return{type:"MultiPoint",coordinates:i}}function Y(){return null}function v(e){return{type:"Point",coordinates:[e.getFloat64(4,!0),e.getFloat64(12,!0)]}}function w(e){var t=44,n,r=e.getInt32(36,!0),i=e.getInt32(40,!0),a=new Array(r),o=new Array(i),u=[],s=[];for(n=0;n<r;++n,t+=4)a[n]=e.getInt32(t,!0);for(n=0;n<i;++n,t+=16)o[n]=[e.getFloat64(t,!0),e.getFloat64(t+8,!0)];return a.forEach(function(f,c){var l=o.slice(f,a[c+1]);Z(l)?u.push([l]):s.push(l)}),s.forEach(function(f){u.some(function(c){if(j(c[0],f))return c.push(f),!0})||u.push([f])}),u.length===1?{type:"Polygon",coordinates:u[0]}:{type:"MultiPolygon",coordinates:u}}function Z(e){if((n=e.length)<4)return!1;for(var t=0,n,r=e[n-1][1]*e[0][0]-e[n-1][0]*e[0][1];++t<n;)r+=e[t-1][1]*e[t][0]-e[t-1][0]*e[t][1];return r>=0}function j(e,t){for(var n=-1,r=t.length,i;++n<r;)if(i=ee(e,t[n]))return i>0;return!1}function ee(e,t){for(var n=t[0],r=t[1],i=-1,a=0,o=e.length,u=o-1;a<o;u=a++){var s=e[a],f=s[0],c=s[1],l=e[u],E=l[0],b=l[1];if(te(s,l,t))return 0;c>r!=b>r&&n<(E-f)*(r-c)/(b-c)+f&&(i=-i)}return i}function te(e,t,n){var r=n[0]-e[0],i=n[1]-e[1];if(r===0&&i===0)return!0;var a=t[0]-e[0],o=t[1]-e[1];if(a===0&&o===0)return!1;var u=(r*a+i*o)/(a*a+o*o);return u<0||u>1?!1:u===0||u===1?!0:u*a===r&&u*o===i}function m(e){var t=44,n,r=e.getInt32(36,!0),i=e.getInt32(40,!0),a=new Array(r),o=new Array(i);for(n=0;n<r;++n,t+=4)a[n]=e.getInt32(t,!0);for(n=0;n<i;++n,t+=16)o[n]=[e.getFloat64(t,!0),e.getFloat64(t+8,!0)];return r===1?{type:"LineString",coordinates:o}:{type:"MultiLineString",coordinates:a.map(function(u,s){return o.slice(u,a[s+1])})}}function F(e,t){var n=new Uint8Array(e.length+t.length);return n.set(e,0),n.set(t,e.length),n}function ne(){var e=this;return++e._index,e._source.slice(12).then(function(t){if(t==null)return{done:!0,value:void 0};var n=h(t);function r(){return e._source.slice(4).then(function(a){return a==null?{done:!0,value:void 0}:(n=h(t=F(t.slice(4),a)),n.getInt32(0,!1)!==e._index?r():i())})}function i(){var a=n.getInt32(4,!1)*2-4,o=n.getInt32(8,!0);return a<0||o&&o!==e._type?r():e._source.slice(a).then(function(u){return{done:!1,value:o?e._parse(h(F(t.slice(8),u))):null}})}return i()})}var U={0:Y,1:v,3:m,5:w,8:g,11:v,13:m,15:w,18:g,21:v,23:m,25:w,28:g};function re(e){return e=I(e),e.slice(100).then(function(t){return new L(e,h(t))})}function L(e,t){var n=t.getInt32(32,!0);if(!(n in U))throw new Error("unsupported shape type: "+n);this._source=e,this._type=n,this._index=0,this._parse=U[n],this.bbox=[t.getFloat64(36,!0),t.getFloat64(44,!0),t.getFloat64(52,!0),t.getFloat64(60,!0)]}var $=L.prototype;$.read=ne;$.cancel=W;function ie(){}function ae(){return Promise.all([this._dbf&&this._dbf.cancel(),this._shp.cancel()]).then(ie)}function ue(){var e=this;return Promise.all([e._dbf?e._dbf.read():{value:{}},e._shp.read()]).then(function(t){var n=t[0],r=t[1];return r.done?r:{done:!1,value:{type:"Feature",properties:n.value,geometry:r.value}}})}function oe(e,t,n){return Promise.all([re(e),t&&Q(t,n)]).then(function(r){return new B(r[0],r[1])})}function B(e,t){this._shp=e,this._dbf=t,this.bbox=e.bbox}var D=B.prototype;D.read=ue;D.cancel=ae;function se(e,t,n){return typeof t=="string"?(/\.dbf$/.test(t)||(t+=".dbf"),t=_(t)):t instanceof ArrayBuffer||t instanceof Uint8Array?t=y(t):t!=null&&(t=A(t)),typeof e=="string"?(/\.shp$/.test(e)||(e+=".shp"),t===void 0&&(t=_(e.substring(0,e.length-4)+".dbf").catch(function(){})),e=_(e)):e instanceof ArrayBuffer||e instanceof Uint8Array?e=y(e):e=A(e),Promise.all([e,t]).then(function(r){var i=r[0],a=r[1],o="windows-1252";return oe(i,a,a&&new TextDecoder(o))})}const fe=e=>new Promise((t,n)=>{const r=new FileReader;r.readAsArrayBuffer(e);const i={type:"FeatureCollection",features:[]};r.onload=function(){se(this.result).then(a=>a.read().then(function o(u){u.done?(u.value&&i.features.push(u.value),t(i)):(i.features.push(u.value),a.read().then(o))})).catch(n)}}),ce=e=>{const t={shp:fe};return new Promise((n,r)=>{const i=e.name.split(".").pop();i&&t[i]?n(t[i](e)):r(new Error(`Can't resolve the .${i} file`))})};export{ce as t};
