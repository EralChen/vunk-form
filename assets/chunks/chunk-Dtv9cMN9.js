import{p as G,V as O,c as X}from"./chunk-DC95vdEF.js";import{r as W}from"./chunk-Wpmjk9Ne.js";import{a as z}from"./chunk-MqsyJY6L.js";import{R as Y}from"./chunk-zKPkODU6.js";import{g as N}from"./chunk-B0yIEhLL.js";import{d as Z,aT as j,s as J,a5 as K,aU as Q,r as P,ay as E,c as ee,aV as te,aW as oe,aX as se,aY as U,E as ne,M as ae,f as S,o as k,a as _,w as R,h as L,b as $,aZ as B,g as V,F as re,G as le,a_ as H,I as de,i as q,m as ie}from"./chunk-CYWh0Wrq.js";import{T as ue}from"./chunk-Ch0SDxT-.js";const fe={...G,fileId:{type:String,default:""},url:{type:String,default:void 0},chunkSize:{type:Number,default:1024*1024*10},fileServiceType:{type:String,default:void 0},fileStatus:{type:String,default:void 0}},ce={"update:fileStatus":null};var o=(e=>(e.wait="wait",e.doPause="doPause",e.pause="pause",e.doDownload="doDownload",e.downloading="downloading",e.error="error",e.done="done",e))(o||{});const M=new Y({baseURL:z.baseURL,presetRequestInit:e=>{const n=e.headers,w=N();return w&&n.set("Token",w),e}}),pe=(e,n)=>new Promise((w,i)=>{const t=new XMLHttpRequest;let b=`${M.baseURL}/file/downloadByRange?fileId=${e.fileId}`;e.fileServiceType&&(b+=`&fileServiceType=${e.fileServiceType}`,t.setRequestHeader("fileServiceType",e.fileServiceType)),n?.onprogress&&(t.onprogress=n?.onprogress),t.open("GET",b,!0),t.responseType="blob",t.setRequestHeader("Token",N()),t.setRequestHeader("tenant","default"),t.setRequestHeader("application","platform"),t.setRequestHeader("Content-Range",`bytes=${e.start}-${e.end}`),t.setRequestHeader("Accept-Ranges","bytes"),t.onreadystatechange=a=>{const c=a.target;if(t.readyState===4)if(t.status===200||t.status===206){if(n?.xhrs){const l=n.xhrs.findIndex(g=>g===t);n.xhrs.splice(l,1)}w({data:c.response})}else t.status===500&&i(c.response)},t.onerror=()=>{i(t.response)};try{t.send()}catch(a){i(a)}n?.xhrs?.push(t)}),me=Z({name:"VkfDownloadPlus",components:{VkfFormItem:O,ElButtonGroup:j,ElButton:J,ElInput:K},props:fe,emits:ce,setup(e,{emit:n}){const w=X(e);Q(()=>{M.baseURL=e.url||z.baseURL});const i=P();t(),E(()=>e.fileId,t);function t(){e.fileId&&W({fileId:e.fileId}).then(r=>{i.value=r})}const b=ee(()=>l.value===o.error?te:oe),a=P([]),c=P([]),l=se({default:o.wait,key:"fileStatus"},e,n),g=()=>{if(!i.value)return;const r=i.value.size,v=i.value.id,C=Math.ceil(r/e.chunkSize);a.value=Array.from({length:C},(m,s)=>{const u=s*e.chunkSize,h=Math.min(u+e.chunkSize,r)-1;let y={};return a.value[s]&&a.value[s].start===u&&a.value[s].end===h&&a.value[s].status===o.done&&(y=a.value[s]),{start:u,end:h,index:s,status:o.wait,fileId:v,fileServiceType:e.fileServiceType,progress:0,...y}}),l.value=o.downloading;const I=a.value.filter(m=>m.status===o.wait||m.status===o.error);p(I).then(()=>{const m=a.value.map(s=>s.data);return new Blob(m,{type:"application/octet-stream"})}).then(m=>{const s=URL.createObjectURL(m),u=document.createElement("a");u.href=s,u.download=i.value?.realName||"未知文件",u.click(),URL.revokeObjectURL(s)}).then(()=>{l.value=o.done}).catch(()=>{l.value=o.error,ne.error("下载失败")})};E(()=>l.value,r=>{r===o.doDownload&&g()});function p(r,v=4,C=10){return new Promise((I,m)=>{const s=r.length;let u=0;if(s===0)return I(void 0);const h=[],y=async()=>{for(;u<s&&v>0;){v--;const A=r.findIndex(d=>d.status===o.wait||d.status===o.error),f=r[A];f&&(f.status=o.downloading,pe(f,{onprogress(d){f.progress=parseInt(d.loaded/d.total*100+"")},xhrs:c.value}).then(d=>{f.status=o.done,f.data=d.data,v++,u++}).then(()=>{u===s?I(void 0):y()}).catch(()=>{f.status=o.error;const d=f.index;if(typeof h[d]!="number"&&(h[d]=0),h[d]++,console.warn(d,f,h[d],"次报错"),f.progress=-1,h[d]>=C)return m();v++,y()}))}};y()})}const T=()=>{c.value.forEach(r=>{r.abort()}),c.value=[],l.value=o.pause};E(()=>l.value,r=>{r===o.doPause&&T()}),U(()=>{T()});class x extends ue{listener;constructor(v){super(),this.listener=v}add(){window.addEventListener("online",this.listener),this.removeHandler=()=>{window.removeEventListener("online",this.listener)}}}const D=new x(()=>{l.value===o.error&&(l.value=o.doDownload)});return D.add(),U(()=>{D.remove()}),{formItemBindProps:w,fileInfo:i,handleDownload:g,handlePause:T,Status:o,chunks:a,fileStatus:l,filePrefixIcon:b}}}),ve={class:"vkf-download-plus-main"},he={class:"vkf-download-plus-label"},we={key:0,class:"vkf-download-plus-cube-x"};function ge(e,n,w,i,t,b){const a=S("ElInput"),c=S("el-button"),l=S("el-button-group"),g=S("VkfFormItem");return k(),_(g,ie(e.formItemBindProps,{class:"vkf-download-plus"}),{default:R(()=>[L("div",ve,[L("label",he,[$(a,{class:B({"is-error":e.fileStatus===e.Status.error}),"prefix-icon":e.filePrefixIcon,"model-value":e.fileInfo?.realName,readonly:""},null,8,["class","prefix-icon","model-value"]),e.fileStatus===e.Status.downloading||e.fileStatus===e.Status.pause?(k(),V("div",we,[(k(!0),V(re,null,le(e.chunks,p=>(k(),V("div",{key:p.fileId+"-"+p.index,class:B(["vkf-download-plus-cube",{error:p.status==e.Status.error}]),style:H({width:100/e.chunks.length+"%"})},[L("div",{class:B({uploading:p.progress>0&&p.progress<100,success:p.progress==100}),style:H({height:p.progress+"%"})},null,6)],6))),128))])):de("",!0)]),$(l,{class:"vkf-download-plus-btng"},{default:R(()=>[e.fileStatus===e.Status.downloading?(k(),_(c,{key:0,type:"danger",onClick:e.handlePause},{default:R(()=>n[0]||(n[0]=[q(" 暂停 ")])),_:1},8,["onClick"])):(k(),_(c,{key:1,type:"primary",onClick:e.handleDownload},{default:R(()=>n[1]||(n[1]=[q(" 下载 ")])),_:1},8,["onClick"]))]),_:1})])]),_:1},16)}const F=ae(me,[["render",ge]]);F.install=e=>{e.component(F.name||"VkfDownloadPlus",F)};export{F as V};
